<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="./components/cer-layout.html">
<link rel="import" href="./components/cer-login.html">
<link rel="import" href="./cer-styles.html">

<link rel="lazy-import" href="cer-404.html">
<link rel="lazy-import" href="cer-home.html">
<link rel="lazy-import" href="cer-participantes.html">
<link rel="lazy-import" href="cer-funcionarios.html">
<link rel="lazy-import" href="cer-voluntarios.html">
<link rel="lazy-import" href="cer-fornecedores.html">
<link rel="lazy-import" href="cer-usuarios.html">

<dom-module id="cer-app">
  <template>
    <style>
      paper-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>

    <paper-spinner id="loading" active></paper-spinner>
    
    <cer-login id="login"></cer-login>

    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{_routeData}}" tail="{{_subroute}}"></app-route>

    <dom-if if="[[user]]">
      <template>
        <cer-layout page="[[page]]">
          <cer-home name="home"></cer-home>
          <cer-participantes name="participantes"></cer-participantes>
          <cer-funcionarios name="funcionarios"></cer-funcionarios>
          <cer-voluntarios name="voluntarios"></cer-voluntarios>
          <cer-fornecedores name="fornecedores"></cer-fornecedores>
          <cer-usuarios name="usuarios"></cer-usuarios>
          <cer-404 name="404"></cer-404>
        </cer-layout>
      </template>
    </dom-if>

    <paper-toast id="toast"></paper-toast>    
  </template>

  <script>
    class App extends Polymer.Element {
      static get is() { return 'cer-app'; }

      ready() {
        super.ready();

        // Enable persistence
        firebase.firestore().enablePersistence();

        // Authentication listener
        firebase.auth().onAuthStateChanged(user => this._onAuthStateChanged(user));

        // Toast listener
        this.addEventListener('toast', e => this.$.toast.show(e.detail));
      }

      static get properties() {
        return {
          page: String,
          user: Object,
          _routeData: Object,
          _subroute: String,
        };
      }

      static get observers() {
        return [
          '_onRoutePageChanged(_routeData.page)',
        ];
      }

      _onAuthStateChanged(user) {
        this.$.loading.active = false;
        this.$.login.opened   = null === user;
        this.user             = user;
      }

      _onRoutePageChanged(routePage) {
        this.page = routePage || 'home';

        // Load page import on demand. Show 404 page if fails
        const resolvedPageUrl = this.resolveUrl('cer-' + this.page + '.html');

        Polymer.importHref(resolvedPageUrl, null, () => this.page = '404', true);        
      }
    }

    window.customElements.define(App.is, App);
  </script>
</dom-module>
