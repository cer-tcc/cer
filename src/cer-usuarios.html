<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="cer-styles.html">
<link rel="import" href="../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-password-input/paper-password-input.html">
<link rel="import" href="../bower_components/paper-password-input/match-passwords-validator.html">

<dom-module id="cer-usuarios">
  <template>
    <style include="cer-page-styles">
    </style>

    <paper-fab id="fab" icon="add" elevation="5"></paper-fab>

    <paper-card heading="Usuários">
      <vaadin-grid id="grid" theme="borderless row-dividers">
        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="nome">Nome</vaadin-grid-sorter>
          </template>
          <template>[[item.nome]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="sobrenome">Sobrenome</vaadin-grid-sorter>
          </template>
          <template>[[item.sobrenome]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
              <vaadin-grid-sorter path="email">Email</vaadin-grid-sorter>
          </template>
          <template>[[item.email]]</template>
        </vaadin-grid-column>
      </vaadin-grid>
    </paper-card>

    <vaadin-dialog id="dialog" opened="{{dialogOpened}}">
      <template>
        <paper-card heading="Usuario">
          <dom-if if="{{dialogOpened}}" restamp>
            <template>
              <iron-form id="form" class="card-content">
                <form>
                  <vaadin-form-layout>
                    <paper-input label="Nome" name="nome" value="{{document.nome}}" tabindex="1" required></paper-input>
                    <paper-input label="Sobrenome" name="sobrenome" value="{{document.sobrenome}}" tabindex="2" required></paper-input>
                    <paper-input type="email" label="E-mail" name="email" value="{{document.email}}" tabindex="3" required auto-validate></paper-input>
                    <br>

                    <paper-password-input name="senha" label="Senha" value="{{document.password}}" required="[[!document.id]]"></paper-password-input>
                    <paper-password-input label="Confirmar senha" auto-validate validator="match-passwords-validator" required="[[!document.id]]" error-message="As senhas não coincidem"></paper-password-input>
                    <match-passwords-validator id="match-passwords-validator" password="[[document.password]]"></match-passwords-validator>
                  </vaadin-form-layout>
                </form>
              </iron-form>
            </template>
          </dom-if>

          <div class="card-actions layout horizontal justified">
            <span>
              <paper-button class="red" on-tap="_excluir" hidden="[[!document.id]]">Excluir</paper-button>
            </span>

            <span>
              <paper-button on-tap="_closeDialog">Cancelar</paper-button>
              <paper-button class="primary" autofocus raised on-tap="_salvar">Salvar</paper-button>
            </span>
          </div>
        </paper-card>
      </template>
    </vaadin-dialog>
  </template>

  <script type="module">
    import { CrudPage } from './CrudPage.js';

    class UsuariosPage extends CrudPage(Polymer.Element) {
      static get is() { return 'cer-usuarios'; }

      constructor() {
        super();

        this.collection   = firebase.firestore().collection('usuarios');
        this.queryFactory = (params) => this.collection;
      }

      ready() {
        super.ready();

        const getNome = (e) => `${e.detail.data.nome} ${e.detail.data.sobrenome}`;

        this.addEventListener('document-added', e => this._log(`Usuário ${getNome(e)} adicionado`));
        this.addEventListener('document-updated', e => this._log(`Usuário ${getNome(e)} atualizado`));
        this.addEventListener('document-deleted', e => this._log(`Usuário ${getNome(e)} excluído`));
      }

      _openDialog(document) {
        delete document.senha;

        super._openDialog(document);
      }

      _salvar() {
        this.document.sincronizado = false;

        super._salvar();
      }
    }

    window.customElements.define(UsuariosPage.is, UsuariosPage);
  </script>
</dom-module>
